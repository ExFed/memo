name: Release

on:
  push:
    tags:
      - 'v*.*.*'

jobs:
  build-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
    - uses: actions/checkout@v4

    - name: Install GNU Guix
      uses: PromyLOPh/guix-install-action@v1

    - name: Update Cargo.toml version
      run: |
        VERSION=${GITHUB_REF#refs/tags/v}
        sed -i "s/^version = \".*\"/version = \"$VERSION\"/" Cargo.toml

    - name: Build with Guix
      id: build
      run: |
        VERSION=${GITHUB_REF#refs/tags/v}
        export GUIX_PACKAGE_VERSION=$VERSION

        # Build and capture the output path. We need to use -E to preserve the
        # environment variable inside the build container if using container
        # features But for 'guix build -f file.scm', the evaluation happens in
        # the current shell context first
        OUT_PATH=$(guix time-machine -C channels.scm -- build -f guix.scm)
        echo "out_path=$OUT_PATH" >> $GITHUB_OUTPUT

        # Create a release directory
        mkdir release-artifact

        # Copy the binary from the store to the release directory
        cp "$OUT_PATH/bin/memo" release-artifact/

        # Verify the binary exists
        ls -la release-artifact/

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: release-artifact/memo
        generate_release_notes: true
